# Bug Fixes - November 17, 2024

## Summary

Fixed three critical bugs related to port inconsistencies and incorrect import
paths in agent configurations.

---

## Bug 1: PMAgent Port Inconsistency

### Issue

The `PMAgent` class in `agent/pm_graph.py` was configured to use port 8001,
while the rest of the system (including `SimplifiedPMAgent` and the backend)
uses port 8000.

### Impact

- PMAgent would fail to connect to backend API endpoints like
  `/api/tools/notion/create-story`
- API calls would timeout or fail with connection refused errors

### Root Cause

The backend was migrated to run on port 8000 (as configured in
`docker-compose.yml` line 96), but `pm_graph.py` was not updated.

### Fix

**File**: `agent/pm_graph.py` **Line**: 44 **Change**:

```python
# Before
def __init__(self, mcp_base_url: str = "http://localhost:8001"):

# After
def __init__(self, mcp_base_url: str = "http://localhost:8000"):
```

### Verification

- ✅ Consistent with `SimplifiedPMAgent` (line 16 of `pm_agent_simple.py`)
- ✅ Matches backend port in `docker-compose.yml`
- ✅ Aligns with `backend/main.py` configuration

---

## Bug 2: IOAgent Import Path Error

### Issue

The `dev_io_agent.yaml` configuration specified handler paths as
`agents.workers.io_agent.IOAgent.*`, but the `IOAgent` class is actually located
in `agents/io_agent.py`, not in a `workers` subdirectory.

### Impact

- `AgentLoader` would fail with `ImportError` when attempting to load the
  IOAgent
- All IOAgent handler methods would be unreachable
- The I/O agent (responsible for channel detection and normalization) would be
  non-functional

### Root Cause

Incorrect assumption about file structure. The `agents/workers/` directory
contains different agents (`ContextAgent`, `CoherenceAgent`, `PMAgent`), not
`IOAgent`.

### Fix

**File**: `agents/dev_io_agent.yaml` **Lines**: 28, 35, 42, 49 **Change**:

```yaml
# Before
handler: agents.workers.io_agent.IOAgent.detect_channel
handler: agents.workers.io_agent.IOAgent.normalize_input
handler: agents.workers.io_agent.IOAgent.route_to_supervisor
handler: agents.workers.io_agent.IOAgent.format_output

# After
handler: agents.io_agent.IOAgent.detect_channel
handler: agents.io_agent.IOAgent.normalize_input
handler: agents.io_agent.IOAgent.route_to_supervisor
handler: agents.io_agent.IOAgent.format_output
```

### Verification

- ✅ Confirmed `agents/io_agent.py` exists and contains `IOAgent` class
- ✅ No `agents/workers/io_agent.py` file exists
- ✅ Import path now matches actual file structure

---

## Bug 3: SupervisorAgent Import Path Error

### Issue

The `dev_supervisor_agent.yaml` configuration specified handler paths as
`agents.workers.supervisor_agent.SupervisorAgent.*`, but the `SupervisorAgent`
class is actually located in `agents/supervisor_agent.py`, not in a `workers`
subdirectory.

### Impact

- `AgentLoader` would fail with `ImportError` when attempting to load the
  SupervisorAgent
- All SupervisorAgent handler methods would be unreachable
- The supervisor agent (responsible for routing and orchestration) would be
  non-functional
- Multi-agent workflows would fail

### Root Cause

Same as Bug 2 - incorrect assumption about file structure.

### Fix

**File**: `agents/dev_supervisor_agent.yaml` **Lines**: 28, 35, 42, 49, 56, 63
**Change**:

```yaml
# Before
handler: agents.workers.supervisor_agent.SupervisorAgent.analyze_request
handler: agents.workers.supervisor_agent.SupervisorAgent.load_context
handler: agents.workers.supervisor_agent.SupervisorAgent.select_workers
handler: agents.workers.supervisor_agent.SupervisorAgent.route_to_workers
handler: agents.workers.supervisor_agent.SupervisorAgent.aggregate_results
handler: agents.workers.supervisor_agent.SupervisorAgent.compile_coherent_response

# After
handler: agents.supervisor_agent.SupervisorAgent.analyze_request
handler: agents.supervisor_agent.SupervisorAgent.load_context
handler: agents.supervisor_agent.SupervisorAgent.select_workers
handler: agents.supervisor_agent.SupervisorAgent.route_to_workers
handler: agents.supervisor_agent.SupervisorAgent.aggregate_results
handler: agents.supervisor_agent.SupervisorAgent.compile_coherent_response
```

### Verification

- ✅ Confirmed `agents/supervisor_agent.py` exists and contains
  `SupervisorAgent` class
- ✅ No `agents/workers/supervisor_agent.py` file exists
- ✅ Import path now matches actual file structure

---

## File Structure Reference

### Actual Structure

```
agents/
├── io_agent.py                    # IOAgent class
├── supervisor_agent.py            # SupervisorAgent class
├── dev_io_agent.yaml             # IOAgent configuration
├── dev_supervisor_agent.yaml     # SupervisorAgent configuration
└── workers/
    ├── __init__.py
    ├── context_agent.py          # ContextAgent class
    ├── coherence_agent.py        # CoherenceAgent class
    └── pm_agent.py               # PMAgent class (worker version)
```

### Import Path Convention

- **Top-level agents**: `agents.<module>.<Class>`
  - Example: `agents.io_agent.IOAgent`
  - Example: `agents.supervisor_agent.SupervisorAgent`
- **Worker agents**: `agents.workers.<module>.<Class>`
  - Example: `agents.workers.context_agent.ContextAgent`
  - Example: `agents.workers.coherence_agent.CoherenceAgent`

---

## Testing Recommendations

### 1. Test PMAgent Connectivity

```python
from agent.pm_graph import PMAgent

agent = PMAgent()
# Should connect to http://localhost:8000
# Verify by checking agent.mcp_base_url
assert agent.mcp_base_url == "http://localhost:8000"
```

### 2. Test IOAgent Import

```python
from agents.agent_loader import AgentLoader

loader = AgentLoader()
io_agent = loader.load_agent("dev_io_agent.yaml")
# Should successfully import IOAgent without ImportError
```

### 3. Test SupervisorAgent Import

```python
from agents.agent_loader import AgentLoader

loader = AgentLoader()
supervisor = loader.load_agent("dev_supervisor_agent.yaml")
# Should successfully import SupervisorAgent without ImportError
```

### 4. Integration Test

```bash
# Start the backend
docker-compose up foundry-backend

# Verify PMAgent can reach backend
curl http://localhost:8000/health

# Test agent loading
python -c "from agents.agent_registry import AgentRegistry; registry = AgentRegistry(); registry.load_all_agents()"
```

---

## Related Files

### Modified

- `agent/pm_graph.py` - Line 44
- `agents/dev_io_agent.yaml` - Lines 28, 35, 42, 49
- `agents/dev_supervisor_agent.yaml` - Lines 28, 35, 42, 49, 56, 63

### Referenced

- `agent/pm_agent_simple.py` - Line 16 (reference for correct port)
- `docker-compose.yml` - Line 96 (backend port configuration)
- `backend/main.py` - Backend server configuration
- `agents/io_agent.py` - IOAgent implementation
- `agents/supervisor_agent.py` - SupervisorAgent implementation

---

## Prevention

### Code Review Checklist

- [ ] Verify port numbers match across all agent configurations
- [ ] Confirm import paths match actual file structure
- [ ] Test agent loading with `AgentLoader` before committing
- [ ] Run integration tests with backend running
- [ ] Check `docker-compose.yml` for service port mappings

### Future Improvements

1. **Centralized Configuration**: Create a `config.py` with constants for ports
   and base URLs
2. **Import Path Validation**: Add validation in `AgentLoader` to verify handler
   paths exist
3. **Integration Tests**: Add automated tests that verify agent loading and
   connectivity
4. **Documentation**: Update agent development guide with correct import path
   conventions
